<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex,nofollow">
    <title>IBONARIUM PLANET RADAR</title>
    <style>
        /* ================= RESET & BODY ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            color: #9fe7ff;
            font-family: "Courier New", monospace;
            overflow: hidden;
        }
        /* ================= STARS BACKGROUND ================= */
        #starsCanvas {
            position: fixed;
            inset: 0;
            z-index: 0;
        }
        /* ================= MAP CANVAS ================= */
        #mapCanvas {
            position: fixed;
            inset: 0;
            z-index: 1;
        }
        /* ================= WRAPPER (внизу) ================= */
        .wrapper {
            position: fixed;
            bottom: 15px;
            left: 0;
            right: 0;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 8px;
            pointer-events: none;
        }
        /* ================= CITY MARKERS ================= */
        .city-markers {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            pointer-events: auto;
            text-align: center;
        }
        .city-markers .title {
            font-size: 12px;
            letter-spacing: 1.5px;
            opacity: 0.8;
        }
        .city-markers .data-line {
            font-size: 11px;
            letter-spacing: 1.2px;
            opacity: 0.9;
        }
        /* ================= CONTROLS ================= */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }
        button {
            background: transparent;
            border: 1px solid #4dd2ff;
            color: #4dd2ff;
            font-family: "Courier New", monospace;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
            pointer-events: auto;
        }
        button:hover {
            background: rgba(77,210,255,0.15);
            box-shadow: 0 0 10px rgba(77,210,255,0.6);
        }
        button.active {
            background: #4dd2ff;
            color: #000;
            box-shadow: 0 0 18px #4dd2ff;
        }
        /* ================= TEXT ================= */
        .text-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: center;
            pointer-events: auto;
        }
        .main-text {
            font-size: 14px;
            letter-spacing: 1px;
        }
        .sub-text {
            font-size: 12px;
            letter-spacing: 1px;
            opacity: 0.8;
        }
        .footer-text {
            font-size: 10px;
            letter-spacing: 1px;
            opacity: 0.6;
        }
        .footer-text a {
            color: #4dd2ff;
            text-decoration: underline;
        }
        /* ================= MOBILE ================= */
        @media (max-width: 600px) {
            button {
                font-size: 10px;
                padding: 4px 8px;
            }
            .main-text { font-size: 13px; }
            .sub-text { font-size: 11px; }
            .footer-text { font-size: 9px; }
            .wrapper { bottom: 8px; gap: 8px; }
            .city-markers .title, .city-markers .data-line {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <canvas id="starsCanvas"></canvas>
    <canvas id="mapCanvas"></canvas>

    <div class="wrapper">
        <!-- Блок міст -->
        <div class="city-markers">
            <div class="title">РАДАР МІСТ</div>
            <div class="data-line" id="city-data">ЗАВАНТАЖЕННЯ...</div>
        </div>

        <!-- Кнопки перемикання шарів -->
        <div class="controls">
            <button class="layerBtn active" data-layer="clouds_new">ХМАРИ</button>
            <button class="layerBtn" data-layer="temp_new">ТЕМПЕРАТУРА</button>
            <button class="layerBtn" data-layer="precipitation_new">ОПАДИ</button>
            <button class="layerBtn" data-layer="wind_new">ВІТЕР</button>
            <button class="layerBtn" data-layer="pressure_new">ТИСК</button>
            <button class="layerBtn" data-layer="relief">РЕЛЬЄФ</button>
            <button class="layerBtn" data-layer="snow_new">СНІГ</button>
            <button class="layerBtn" data-layer="rain_new">ДОЩ</button>
        </div>

        <!-- Текстова інформація -->
        <div class="text-block">
            <div class="main-text" id="status">СКАНУВАННЯ...</div>
            <div class="sub-text">
                Ibonarium Cosmo Dynamics Lab LIVE — Center for Space & Planetary Monitoring
            </div>
            <div class="footer-text">
                <a href="https://t.me/ibonariumcosmodynamicslablive" target="_blank">
                    https://t.me/ibonariumcosmodynamicslablive
                </a>
                <br>
                2026 ibonarium project by Roman Katyuschenko
            </div>
        </div>
    </div>

    <script>
        /* ================= STARS BACKGROUND ================= */
        const starsCanvas = document.getElementById("starsCanvas");
        const sctx = starsCanvas.getContext("2d");
        let W = starsCanvas.width = window.innerWidth;
        let H = starsCanvas.height = window.innerHeight;
        const stars = [];
        const numStars = 300;
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * W,
                y: Math.random() * H,
                size: Math.random() * 1.5 + 0.5,
                speed: Math.random() * 0.5 + 0.1,
                opacity: Math.random() * 0.8 + 0.2
            });
        }
        function drawStars() {
            sctx.clearRect(0, 0, W, H);
            sctx.fillStyle = "#fff";
            stars.forEach(star => {
                sctx.globalAlpha = star.opacity;
                sctx.fillRect(star.x, star.y, star.size, star.size);
                star.y += star.speed;
                if (star.y > H) star.y = 0;
            });
            sctx.globalAlpha = 1;
            requestAnimationFrame(drawStars);
        }
        drawStars();

        /* ================= MAP RADAR ================= */
        const API_KEY = "b99fdb51e2dcc8e0549f8b99ef20cedd";
        const ZOOM = 2;
        const TILE_SIZE = 256;
        const mapCanvas = document.getElementById("mapCanvas");
        const ctx = mapCanvas.getContext("2d");
        mapCanvas.width = W;
        mapCanvas.height = H;

        let currentLayer = "clouds_new";
        let baseTiles = {};
        let layerTiles = {};
        let lastUpdate = 0;
        const UPDATE_INTERVAL = 15 * 60 * 1000;

        const BASE_URL = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";

        const cities = [
            {name: "KYIV", lat: 50.45, lon: 30.52},
            {name: "TOKYO", lat: 35.68, lon: 139.76},
            {name: "NIGHT CITY", lat: 37.77, lon: -122.42},
            {name: "MOSCOW", lat: 55.75, lon: 37.62},
            {name: "BERLIN", lat: 52.52, lon: 13.40}
        ];

        async function fetchBaseTile(x, y) {
            const key = `${x}_${y}`;
            if (baseTiles[key]) return baseTiles[key];
            const url = BASE_URL.replace('{z}', ZOOM).replace('{x}', x).replace('{y}', y);
            const img = new Image();
            img.crossOrigin = "anonymous";
            return new Promise(resolve => {
                img.onload = () => { baseTiles[key] = img; resolve(img); };
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }

        async function fetchLayerTile(x, y) {
            const key = `${currentLayer}_${x}_${y}`;
            if (layerTiles[key]) return layerTiles[key];
            let url = `https://tile.openweathermap.org/map/${currentLayer}/${ZOOM}/${x}/${y}.png?appid=${API_KEY}`;
            const img = new Image();
            img.crossOrigin = "anonymous";
            return new Promise(resolve => {
                img.onload = () => { layerTiles[key] = img; resolve(img); };
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }

        async function loadMap() {
            const statusEl = document.getElementById("status");
            statusEl.textContent = "СКАНУВАННЯ ПЛАНЕТИ...";

            const tilesCount = 1 << ZOOM;
            const promises = [];
            for (let x = 0; x < tilesCount; x++) {
                for (let y = 0; y < tilesCount; y++) {
                    promises.push(fetchBaseTile(x, y));
                    promises.push(fetchLayerTile(x, y));
                }
            }
            await Promise.all(promises);

            renderMap();
            await renderCityMarkers();

            let layerName = currentLayer.replace('_new', '').toUpperCase();
            if (layerName === 'RELIEF') layerName = 'РЕЛЬЄФ';
            if (layerName === 'SNOW') layerName = 'СНІГ';
            if (layerName === 'RAIN') layerName = 'ДОЩ';
            statusEl.textContent = `РАДАР: ${layerName} АКТИВНИЙ`;
            lastUpdate = Date.now();
        }

        function renderMap() {
            ctx.clearRect(0, 0, W, H);

            const tilesCount = 1 << ZOOM;
            const fullMapSize = tilesCount * TILE_SIZE;

            const cropBottom = 0.08;
            const visibleRows = Math.floor(tilesCount * (1 - cropBottom));

            const scale = (W * 0.91) / fullMapSize;

            const mapWidth = fullMapSize * scale;
            const mapHeight = visibleRows * TILE_SIZE * scale;

            const offsetX = (W - mapWidth) / 2;
            const offsetY = (H - mapHeight) / 2 - H * 0.03;

            for (let x = 0; x < tilesCount; x++) {
                for (let y = 0; y < visibleRows; y++) {
                    const bx = offsetX + x * TILE_SIZE * scale;
                    const by = offsetY + y * TILE_SIZE * scale;
                    const tw = TILE_SIZE * scale;
                    const th = TILE_SIZE * scale;

                    const base = baseTiles[`${x}_${y}`];
                    if (base) ctx.drawImage(base, bx, by, tw, th);

                    const layer = layerTiles[`${currentLayer}_${x}_${y}`];
                    if (layer) {
                        // ПІДВИЩЕНИЙ КОНТРАСТ: малюємо шар з повною непрозорістю
                        if (currentLayer !== "relief") {  // рельєф і так щільний
                            ctx.globalAlpha = 1.0;
                        }
                        ctx.drawImage(layer, bx, by, tw, th);
                        ctx.globalAlpha = 1.0; // скидаємо на всяк випадок
                    }
                }
            }

            // Сканлайн ефект
            const time = Date.now() * 0.001;
            ctx.fillStyle = `rgba(77,210,255,${0.05 + 0.03 * Math.sin(time * 3)})`;
            ctx.fillRect(0, H * ((time * 0.5) % 1), W, 3);
        }

        async function fetchCityWeather(city) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${city.lat}&lon=${city.lon}&appid=${API_KEY}&units=metric`);
                const data = await res.json();
                return `${city.name}: ${Math.round(data.main.temp)}°C`;
            } catch {
                return `${city.name}: —`;
            }
        }

        async function renderCityMarkers() {
            const container = document.getElementById("city-data");
            const cityTexts = await Promise.all(cities.map(fetchCityWeather));
            container.textContent = cityTexts.join('  │  ');
        }

        document.querySelectorAll('.layerBtn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (btn.dataset.layer === currentLayer) return;
                document.querySelector('.active')?.classList.remove('active');
                btn.classList.add('active');
                currentLayer = btn.dataset.layer;
                layerTiles = {};
                await loadMap();
            });
        });

        async function autoUpdate() {
            if (Date.now() - lastUpdate > UPDATE_INTERVAL) {
                layerTiles = {};
                await loadMap();
            }
            renderMap();
            requestAnimationFrame(autoUpdate);
        }

        window.addEventListener("resize", () => {
            W = starsCanvas.width = mapCanvas.width = window.innerWidth;
            H = starsCanvas.height = mapCanvas.height = window.innerHeight;
            renderMap();
        });

        loadMap();
        autoUpdate();
    </script>
</body>
</html>
