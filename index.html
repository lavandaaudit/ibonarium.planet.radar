<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex,nofollow">
    <title>ibonarium planet radar</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        html,body {
            height:100%; width:100%;
            background:#000;
            color:#00ff88;
            font-family:"Courier New",monospace;
            overflow:hidden;
        }
        canvas#stars { position:fixed; inset:0; z-index:0; }
        .wrapper {
            position:relative; z-index:2;
            height:100%; padding:20px;
            display:flex; flex-direction:column; gap:24px;
            align-items:center; justify-content:center;
        }
        h1 {
            font-size:16px; letter-spacing:3px; opacity:0.7;
            text-shadow:0 0 8px rgba(0,255,136,0.4);
        }
        .map-container {
            width:100%; max-width:900px; height:70vh;
            background:#000;
            border:1px solid rgba(0,255,136,0.3);
            box-shadow:0 0 30px rgba(0,255,136,0.2);
            position:relative; overflow:hidden;
        }
        #map-canvas {
            width:100%; height:100%;
        }
        .controls {
            display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
        }
        button {
            background:rgba(0,40,60,0.8); 
            border:1px solid rgba(0,255,136,0.4);
            color:#00ff88; padding:8px 16px;
            font-size:12px; letter-spacing:1.5px;
            cursor:pointer; transition:.3s;
        }
        button:hover {
            background:rgba(0,255,136,0.1);
            box-shadow:0 0 15px rgba(0,255,136,0.5);
        }
        button.active {
            background:rgba(0,255,136,0.2);
            box-shadow:0 0 20px rgba(0,255,136,0.6);
            color:#000;
        }
        .status {
            font-size:12px; letter-spacing:2px; opacity:0.6;
        }
    </style>
</head>
<body>
<canvas id="stars"></canvas>
<div class="wrapper">
    <h1>IBONARIUM PLANET RADAR</h1>
    
    <div class="map-container">
        <canvas id="map-canvas"></canvas>
    </div>
    
    <div class="controls">
        <button data-layer="clouds_new" class="active">CLOUDS</button>
        <button data-layer="temp_new">TEMP</button>
        <button data-layer="precipitation_new">PRECIP</button>
        <button data-layer="wind_new">WIND</button>
    </div>
    
    <p class="status" id="status">SCANNING...</p>
</div>

<script>
    /* STARFIELD */
    const starsC = document.getElementById("stars");
    const starsCtx = starsC.getContext("2d");
    let SW, SH, stars = [];
    function resizeStars() {
        SW = starsC.width = innerWidth;
        SH = starsC.height = innerHeight;
        stars = Array.from({length:120}, () => ({
            x: Math.random() * SW, y: Math.random() * SH, z: Math.random() * SW
        }));
    }
    resizeStars();
    window.addEventListener("resize", resizeStars);
    function drawStars() {
        starsCtx.fillStyle = "rgba(0,0,0,0.1)";
        starsCtx.fillRect(0, 0, SW, SH);
        starsCtx.fillStyle = "#00ff88";
        stars.forEach(st => {
            st.z -= 0.08;
            if (st.z <= 0) st.z = SW;
            const k = 120 / st.z;
            const x = (st.x - SW / 2) * k + SW / 2;
            const y = (st.y - SH / 2) * k + SH / 2;
            if (x > 0 && x < SW && y > 0 && y < SH) {
                const size = (1 - st.z / SW) * 1.5;
                starsCtx.globalAlpha = 1 - st.z / SW;
                starsCtx.fillRect(x, y, size, size);
            }
        });
        starsCtx.globalAlpha = 1;
        requestAnimationFrame(drawStars);
    }
    drawStars();

    /* MAP RADAR WITH DARK BASEMAP */
    const API_KEY = "b99fdb51e2dcc8e0549f8b99ef20cedd";
    const ZOOM = 2;
    const TILE_SIZE = 256;
    const canvas = document.getElementById("map-canvas");
    const ctx = canvas.getContext("2d");
    let currentLayer = "clouds_new";
    let baseTiles = {}; // для базової карти
    let weatherTiles = {};
    let lastUpdate = 0;
    const UPDATE_INTERVAL = 15 * 60 * 1000;

    // Темна базова карта (Stamen Toner Lite — чорно-біла, ідеально під кіберпанк)
    const BASE_URL = "https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png";

    function resizeMap() {
        canvas.width = canvas.offsetWidth * devicePixelRatio;
        canvas.height = canvas.offsetHeight * devicePixelRatio;
        ctx.scale(devicePixelRatio, devicePixelRatio);
        canvas.style.width = canvas.offsetWidth / devicePixelRatio + 'px';
        canvas.style.height = canvas.offsetHeight / devicePixelRatio + 'px';
        renderMap();
    }
    window.addEventListener("resize", resizeMap);

    async function fetchBaseTile(x, y) {
        const key = `${x}_${y}`;
        if (baseTiles[key]) return baseTiles[key];
        try {
            const url = BASE_URL.replace('{z}', ZOOM).replace('{x}', x).replace('{y}', y);
            const img = new Image();
            img.crossOrigin = "anonymous";
            return new Promise(resolve => {
                img.onload = () => { baseTiles[key] = img; resolve(img); };
                img.src = url;
            });
        } catch { return null; }
    }

    async function fetchWeatherTile(x, y) {
        const key = `${x}_${y}`;
        if (weatherTiles[key]) return weatherTiles[key];
        try {
            const url = `https://tile.openweathermap.org/map/${currentLayer}/${ZOOM}/${x}/${y}.png?appid=${API_KEY}`;
            const img = new Image();
            img.crossOrigin = "anonymous";
            return new Promise(resolve => {
                img.onload = () => { weatherTiles[key] = img; resolve(img); };
                img.onerror = () => resolve(null);
                img.src = url;
            });
        } catch { return null; }
    }

    async function loadMap() {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "SCANNING PLANET...";

        const tilesCount = 1 << ZOOM;
        const basePromises = [];
        const weatherPromises = [];

        for (let x = 0; x < tilesCount; x++) {
            for (let y = 0; y < tilesCount; y++) {
                basePromises.push(fetchBaseTile(x, y));
                weatherPromises.push(fetchWeatherTile(x, y));
            }
        }

        await Promise.all([...basePromises, ...weatherPromises]);
        renderMap();
        statusEl.textContent = `RADAR: ${currentLayer.replace('_new','').toUpperCase()} ACTIVE`;
        lastUpdate = Date.now();
    }

    function renderMap() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const tilesCount = 1 << ZOOM;
        const tilePixelSize = canvas.width / tilesCount / devicePixelRatio;

        for (let x = 0; x < tilesCount; x++) {
            for (let y = 0; y < tilesCount; y++) {
                const bx = x * tilePixelSize;
                const by = y * tilePixelSize;

                // Базова карта (темна)
                const base = baseTiles[`${x}_${y}`];
                if (base) ctx.drawImage(base, bx, by, tilePixelSize, tilePixelSize);

                // Погодний шар
                const weather = weatherTiles[`${x}_${y}`];
                if (weather) ctx.drawImage(weather, bx, by, tilePixelSize, tilePixelSize);
            }
        }

        // Кіберпанк сканлайн
        const time = Date.now() * 0.001;
        ctx.fillStyle = `rgba(0,255,136,${0.05 + 0.03 * Math.sin(time * 3)})`;
        ctx.fillRect(0, (canvas.height / devicePixelRatio) * (time % 1), canvas.width / devicePixelRatio, 3);
    }

    document.querySelectorAll('button[data-layer]').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (btn.dataset.layer === currentLayer) return;
            document.sinaquerySelector('.active')?.classList.remove('active');
            btn.classList.add('active');
            currentLayer = btn.dataset.layer;
            weatherTiles = {}; // очищаємо кеш погоди
            await loadMap();
        });
    });

    async function autoUpdate() {
        if (Date.now() - lastUpdate > UPDATE_INTERVAL) await loadMap();
        renderMap(); // для анімації сканлайну
        requestAnimationFrame(autoUpdate);
    }

    resizeMap();
    loadMap();
    autoUpdate();
</script>
</body>
</html>
